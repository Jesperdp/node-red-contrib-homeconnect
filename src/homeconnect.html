<script type="text/javascript">
    RED.nodes.registerType('HomeConnectCreds', {
        category: 'config',
        defaults: {
            name: { value: '' }
        },
        credentials: {
            client_id: { type: "text", required: true },
            client_secret: { type: "text", required: true },
            tokens: { type: "text" }
        },
        label: function () {
            return this.name || 'Home Connect Creds';
        },
        oneditsave: function() {
            let currentUri = window.location;
            
            let getUrl = () => {
                $.getJSON('getTokens/' + this.id, {}, function(response) {
                    this.credentials.tokens = JSON.stringify(response.tokens);
                    $("#node-config-input-tokens").val(JSON.stringify(response.tokens));
                })
                .fail(function() {
                });
            };
            getUrl();
        },
        oneditprepare: function() {
            let disableAuthenticationButton = () => {
                $('#node-config-startAuth')
                    .addClass('disabled')
                    .click(function(event) {
                        event.preventDefault();
                    });
            };
            let enableAuthenticationButton = () => {
                $('#node-config-startAuth')
                    .removeClass('disabled')
                    .unbind('click');
            };

            let currentUri = window.location;

            $('#node-config-input-client_id')
            .change(function(event) {
                getUrl();
            });
            
            disableAuthenticationButton();
            
            let getUrl = () => {
                $.getJSON('oauth2/' + this.id + '/auth/url', {
                    protocol: currentUri.protocol,
                    hostname: currentUri.hostname,
                    port: currentUri.port || 80,
                    clientId: $("#node-config-input-client_id").val(),
                    clientSecret: $("#node-config-input-client_secret").val()
                }, function(response) {
                    $('#node-config-startAuth').attr('href', response.url);
                    enableAuthenticationButton();
                })
                .fail(function() {
                    disableAuthenticationButton();
                });
            };
            getUrl();
        }
    });
</script>
<script type="text/x-red" data-template-name="HomeConnectCreds">
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-config-input-client_id">Client ID</label>
        <input type="text" id="node-config-input-client_id">
    </div>
    <div class="form-row">
        <label for="node-config-input-client_secret">Client Secret</label>
        <input type="text" id="node-config-input-client_secret">
    </div>
    <div class="form-row">
        <label for="node-config-input-tokens">Tokens</label>
        <input type="text" id="node-config-input-tokens">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <a class="btn" id="node-config-startAuth" href="#" target="_blank">Authenticate to initialize token</a>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('HomeConnect', {
        category: 'function',
        color: '#2392d8',
        icon: 'bridge.png',
        defaults: {
            name: { value: '' },
            creds: { value: '', type: 'HomeConnectCreds', required: true },
            action: { value: '', required: true },
            haid: { value: '' }
        },
        inputs: 1,
        outputs: 1,
        label: function() {
            return this.name || "HomeConnect";
        },
        oneditprepare: function() {
            $('#node-input-action')
            .change(function(event) {
                if (this.value == 'get_home_appliances') {
                    $('#node-input-haid')
                    .prop('disabled', true)
                } else {
                    $('#node-input-haid')
                    .prop('disabled', false);
                }
            });
        }
    });
</script>
<script type="text/x-red" data-template-name="HomeConnect">
    <div class="form-row">
        <label for="node-input-client_creds">Creds</label>
        <input type="text" id="node-input-creds">
    </div>
    <div class="form-row">
        <label for="node-input-action">Action</label>
        <select id="node-input-action">
            <option value="get_home_appliances">home appliances</option>
            <option value="get_specific_appliance">specific home appliance</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-haid">HAID</label>
        <input type="text" id="node-input-haid">
    </div>
</script>